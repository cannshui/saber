<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap
	PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
	"http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="board">

	<resultMap id="boardMap" class="dn.cs.saber.domain.Board">
		<result property="id" column="id" />
		<result property="user" column="user" select="getUser" />
		<result property="ip" column="ip" />
		<result property="content" column="content" />
		<result property="replys" column="id" select="getBoardMessageReplys" />
		<result property="reply" column="reply" />
		<result property="cts" column="cts" />
		<result property="uts" column="uts" />
	</resultMap>

	<select id="getBoardMessages" resultMap="boardMap">
		SELECT id, user, content, reply, ip, strftime('%s', cts) * 1000 AS cts, strftime('%s', uts) * 1000 AS uts
		FROM board ORDER BY cts DESC
	</select>

	<select id="getBoardMessagesNumber" resultMap="boardMap">
		SELECT COUNT(1) FROM board
	</select>

	<select id="getLevel0BoardMessagesNumber" resultClass="int">
		SELECT COUNT(1) FROM board WHERE reply is null
	</select>

	<select id="getPagedBoardMessages" parameterClass="dn.cs.saber.vo.PageData" resultMap="boardMap">
		SELECT SELECT id, user, content, reply, ip, strftime('%s', cts) * 1000 AS cts, strftime('%s', uts) * 1000 AS uts
		FROM board WHERE reply is null ORDER BY cts DESC LIMIT #index#, #size#
	</select>

	<select id="getBoardMessage" resultMap="boardMap">
		SELECT SELECT id, user, content, reply, ip, strftime('%s', cts) * 1000 AS cts, strftime('%s', uts) * 1000 AS uts
		FROM board WHERE reply is null ORDER BY cts DESC
	</select>

	<insert id="insertBoard" parameterClass="dn.cs.saber.domain.Board">
		INSERT INTO board (user, content, reply, ip) VALUES (#user.id#, #content#, #reply#, #ip#)
		<selectKey resultClass="int" keyProperty="id">
			SELECT LAST_INSERT_ROWID()
		</selectKey>
	</insert>

	<select id="getBoardMessageReplys" resultMap="boardMap">
		SELECT SELECT id, user, content, reply, ip, strftime('%s', cts) * 1000 AS cts, strftime('%s', uts) * 1000 AS uts
		FROM board WHERE reply = #id# ORDER BY cts DESC
	</select>

</sqlMap>